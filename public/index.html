<!DOCTYPE html>
<html>

<head>
  <title>Snake Paint</title>
  <style>
    canvas {
      border: 1px solid black;
      display: block;
      margin: 20px auto;
      position: relative;
      z-index: 1;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      position: relative;
    }

    .background-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 120px;
      font-family: Arial, sans-serif;
      color: rgba(0, 0, 0, 0.15);
      white-space: nowrap;
      font-weight: bold;
      text-align: center;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="background-text">I LOVE YOU NATHAN</div>
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Draw the initial message on the canvas
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.font = '48px Arial';
    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
    ctx.textAlign = 'center';
    ctx.fillText('I LOVE YOU NATHAN', canvas.width / 2, canvas.height / 2);

    let myId = null;
    socket.on('connect', () => {
      myId = socket.id;
    });
    function checkPixel(x, y, currentX, currentY) {
      if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) return false;
      if (Math.abs(x - currentX) < 2 && Math.abs(y - currentY) < 2) return false;
      const pixel = ctx.getImageData(Math.round(x), Math.round(y), 1, 1).data;
      return pixel[0] !== 255 || pixel[1] !== 255 || pixel[2] !== 255;
    }
    function checkCollision(player) {
      const isOver = checkPixel(player.x, player.y, player.x, player.y);
      const lookAhead = 3;
      const angles = [-0.2, -0.1, 0, 0.1, 0.2];
      let isAboutToHit = false;
      for (const angleOffset of angles) {
        const checkAngle = player.angle + angleOffset;
        const aheadX = player.x + Math.cos(checkAngle) * lookAhead;
        const aheadY = player.y + Math.sin(checkAngle) * lookAhead;
        if (!isOver && checkPixel(aheadX, aheadY, player.x, player.y)) {
          isAboutToHit = true;
          break;
        }
      }
      return {isAboutToHit, isOver};
    }
    socket.on('gameState', (gameState) => {
      const players = new Map(gameState);
      players.forEach((player, id) => {
        let color;
        if (id === myId) {
          const {isAboutToHit, isOver} = checkCollision(player);
          socket.emit('pixelState', {isAboutToHit, isOver});
          if (isOver) {
            color = '#00ff00';
          } else if (isAboutToHit) {
            color = '#ffff00';
          } else {
            color = '#ff0000';
          }
        } else {
          if (player.is_over) {
            color = '#00ff00';
          } else if (player.is_about_to_hit) {
            color = '#ffff00';
          } else {
            color = '#0000ff';
          }
        }
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(player.x, player.y, 2, 0, Math.PI * 2);
        ctx.fill();
      });
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        socket.emit('turn', -1);
      } else if (e.key === 'ArrowRight') {
        socket.emit('turn', 1);
      } else if (e.key === 'r') {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        // Redraw the text after reset
        ctx.font = '48px Arial';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.textAlign = 'center';
        ctx.fillText('I LOVE YOU NATHAN', canvas.width / 2, canvas.height / 2);
      }
    });
    document.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        socket.emit('turn', 0);
      }
    });
  </script>
</body>

</html>
